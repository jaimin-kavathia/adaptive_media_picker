name: Flutter CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout source
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Flutter (reads version from .fvm/fvm_config.json if present)
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: stable
          architecture: x64

      # Cache pub dependencies
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}

      # Install dependencies (root + example)
      - name: Install dependencies
        run: |
          flutter pub get
          if [ -d "example" ]; then
            (cd example && flutter pub get)
          fi

      # Format (write changes to avoid failing the job on formatting diffs)
      - name: Format code (root and example)
        run: |
          dart format -o write .
          if [ -d "example" ]; then
            (cd example && dart format -o write .)
          fi

      # Analyze root
      - name: Analyze root
        run: flutter analyze

      # Analyze example (if exists)
      - name: Analyze example
        if: ${{ hashFiles('example/pubspec.yaml') != '' }}
        run: (cd example && flutter analyze)

      # Run tests root
      - name: Run tests (root)
        run: flutter test --no-pub

      # Run tests example (if exists)
      - name: Run tests (example)
        if: ${{ hashFiles('example/pubspec.yaml') != '' }}
        run: (cd example && flutter test --no-pub)